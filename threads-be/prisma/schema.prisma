generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  username     String   @unique
  email        String   @unique
  passwordHash String   @map("password_hash")
  displayName  String?  @map("display_name")
  bio          String?
  avatarUrl    String?  @map("avatar_url")
  verified     Boolean  @default(false)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  posts              Post[]
  likes              Like[]
  reposts            Repost[]
  refreshTokens      RefreshToken[]
  followers          Follow[]                  @relation("UserFollowers")
  following          Follow[]                  @relation("UserFollowing")
  notifications      Notification[]            @relation("NotificationRecipient")
  actorNotifications Notification[]            @relation("NotificationActor")
  blocking           Block[]                   @relation("Blocker")
  blockedBy          Block[]                   @relation("Blocked")
  muting             Mute[]                    @relation("Muter")
  mutedBy            Mute[]                    @relation("Muted")
  conversations      ConversationParticipant[]
  messages           Message[]

  @@map("users")
}

model Post {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  content      String   @db.Text
  parentPostId String?  @map("parent_post_id")
  rootPostId   String?  @map("root_post_id")
  replyCount   Int      @default(0) @map("reply_count")
  likeCount    Int      @default(0) @map("like_count")
  repostCount  Int      @default(0) @map("repost_count")
  isDeleted    Boolean  @default(false) @map("is_deleted")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  parentPost    Post?          @relation("PostReplies", fields: [parentPostId], references: [id], onDelete: Cascade)
  replies       Post[]         @relation("PostReplies")
  rootPost      Post?          @relation("ThreadRoot", fields: [rootPostId], references: [id], onDelete: Cascade)
  thread        Post[]         @relation("ThreadRoot")
  media         PostMedia[]
  likes         Like[]
  reposts       Repost[]
  notifications Notification[]

  @@index([userId])
  @@index([parentPostId])
  @@index([rootPostId])
  @@index([createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@map("posts")
}

model PostMedia {
  id         String    @id @default(cuid())
  postId     String    @map("post_id")
  mediaUrl   String    @map("media_url")
  mediaType  MediaType @map("media_type")
  orderIndex Int       @map("order_index")
  createdAt  DateTime  @default(now()) @map("created_at")

  // Relations
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@map("post_media")
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String   @map("follower_id")
  followingId String   @map("following_id")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  follower  User @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("follows")
}

model Like {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  postId    String   @map("post_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([postId])
  @@index([userId])
  @@map("likes")
}

model Repost {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  postId    String   @map("post_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([postId])
  @@index([userId])
  @@map("reposts")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String           @map("user_id")
  actorId   String           @map("actor_id")
  type      NotificationType
  postId    String?          @map("post_id")
  isRead    Boolean          @default(false) @map("is_read")
  createdAt DateTime         @default(now()) @map("created_at")

  // Relations
  user  User  @relation("NotificationRecipient", fields: [userId], references: [id], onDelete: Cascade)
  actor User  @relation("NotificationActor", fields: [actorId], references: [id], onDelete: Cascade)
  post  Post? @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, createdAt(sort: Desc)])
  @@map("notifications")
}

model Block {
  id        String   @id @default(cuid())
  blockerId String   @map("blocker_id")
  blockedId String   @map("blocked_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  blocker User @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked User @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
  @@map("blocks")
}

model Mute {
  id        String   @id @default(cuid())
  muterId   String   @map("muter_id")
  mutedId   String   @map("muted_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  muter User @relation("Muter", fields: [muterId], references: [id], onDelete: Cascade)
  muted User @relation("Muted", fields: [mutedId], references: [id], onDelete: Cascade)

  @@unique([muterId, mutedId])
  @@index([muterId])
  @@index([mutedId])
  @@map("mutes")
}

model Conversation {
  id            String    @id @default(cuid())
  isGroup       Boolean   @default(false) @map("is_group")
  groupName     String?   @map("group_name")
  groupAvatar   String?   @map("group_avatar")
  lastMessageAt DateTime? @map("last_message_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  participants ConversationParticipant[]
  messages     Message[]

  @@map("conversations")
}

model ConversationParticipant {
  id             String    @id @default(cuid())
  conversationId String    @map("conversation_id")
  userId         String    @map("user_id")
  lastReadAt     DateTime? @map("last_read_at")
  joinedAt       DateTime  @default(now()) @map("joined_at")

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([userId])
  @@index([conversationId])
  @@map("conversation_participants")
}

model Message {
  id             String      @id @default(cuid())
  conversationId String      @map("conversation_id")
  senderId       String      @map("sender_id")
  content        String?     @db.Text
  messageType    MessageType @default(TEXT) @map("message_type")
  mediaUrl       String?     @map("media_url")
  isDeleted      Boolean     @default(false) @map("is_deleted")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt(sort: Desc)])
  @@index([senderId])
  @@map("messages")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// Enums
enum MediaType {
  IMAGE
  VIDEO
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  POST_SHARE
}

enum NotificationType {
  LIKE
  REPLY
  FOLLOW
  MENTION
  REPOST
  MESSAGE
}
